<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
	<Product Id="{07939A2A-61BA-4249-B953-0E9803C7E688}" Name="Server_Installer" Language="1033" Version="1.0.0.0" Manufacturer="Open Source Automation" UpgradeCode="337e7999-a302-4c1e-b448-b3b9ca94c998">
		<Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" CompressionLevel="high"  />
    <Binary Id="CustomActionsBinary" SourceFile="$(var.SolutionDir)RegKeys\bin\x86\Combined\OSAInstallCustomActions.CA.dll" />
    
    <!-- Required by the Installer for DB installation and upgrades -->
    <Binary Id="MySQLBinary" SourceFile="..\..\Assemblies\MySql.Data.dll" />

    <Feature Id="ProductFeature" Title="OSA Server" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="group_WebServer" />
      <MergeRef Id='Plugins' />
      <MergeRef Id='ServerMergeModule' />
    </Feature>

    <CustomAction Id="DBUpdateCustomAction"
          BinaryKey="CustomActionsBinary"
          DllEntry="DatabaseUpdate"
          Execute="deferred"
          Return="check" />

    <InstallExecuteSequence>
      <Custom Action="DBUpdateCustomAction" Before="InstallFinalize">
        NOT Installed
      </Custom>
    </InstallExecuteSequence>
    
  </Product>
  
  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="INSTALLFOLDER" Name="INSTALLLOCATION" >
        <Merge Id='ServerMergeModule' Language='1033' src='$(var.SolutionDir)Server\bin\Release\server.msm' DiskId='1' />
        <Directory Id="PluginsFolder" Name="Plugins" >
          <Merge Id='Plugins' Language='1033' src='$(var.SolutionDir)\Plugins\bin\Release\Plugins.msm' DiskId='1' />        
        </Directory>
      </Directory>
    </Directory>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
    </ComponentGroup>
  </Fragment>
</Wix>